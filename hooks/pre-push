#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

#exec >/dev/tty 2>&1
exec < /dev/tty

GREEN='\033[0;32m'
RED='\033[0;31m'
NOCOLOR='\033[0m'
echo "${GREEN}----------------------PRE-PUSH----------------------${NOCOLOR}"

REMOTE_SHA=$(git rev-parse HEAD)

if [ "$(git symbolic-ref HEAD)" = "refs/heads/main" ]; then
  frontend_files_changed=$(git diff --name-only "$REMOTE_SHA" HEAD | grep -e ^frontend | wc -l)
  backend_files_changed=$(git diff --name-only "$REMOTE_SHA" HEAD | grep -e ^src -e build.gradle | wc -l)
  if [ "$frontend_files_changed" -gt 0 ]; then
    echo "${GREEN}Running frontend tests${NOCOLOR}"
    CI=true yarn --cwd frontend test
    echo "${GREEN}Running frontend build${NOCOLOR}"
    yarn --cwd frontend build
  else
    echo "${RED}No changes made to frontend - SKIPPING TESTS${NOCOLOR}"
  fi
  if [ "$backend_files_changed" -gt 0 ]; then
    echo "${GREEN}Running backend tests${NOCOLOR}"
    CI=true ./gradlew test
  else
    echo "${RED}No changes made to backend - SKIPPING TESTS${NOCOLOR}"
  fi
fi

#./scripts/run-journey-test.sh
